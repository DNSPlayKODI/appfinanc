<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Financeiro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
    header { background: #3498db; color: #fff; text-align: center; padding: 20px 0; font-size: 24px; font-weight: bold; }
    .container { max-width: 1100px; margin: auto; padding: 20px; }
    .cards { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; margin-bottom: 30px; }
    .card { flex: 1; min-width: 220px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .card h3 { margin: 0 0 10px 0; font-size: 16px; color: #555; }
    .card p { font-size: 20px; font-weight: bold; margin: 0; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    button { cursor: pointer; background: #3498db; color: #fff; font-weight: bold; border: none; transition: 0.2s; }
    button:hover { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px; text-align: left; }
    th { background: #3498db; color: #fff; }
    tr:nth-child(even) { background: #f4f6f8; }
    .badge { padding: 5px 10px; border-radius: 5px; color: #fff; font-weight: bold; }
    .alert { background: #e74c3c; color: #fff; padding: 5px 10px; border-radius: 5px; display: inline-block; }
    .charts { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 40px; }
    .chart-container { flex: 1; min-width: 300px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    @media(max-width: 768px) { .cards, .charts { flex-direction: column; } }
</style>
</head>
<body>
<header>Dashboard Financeiro</header>
<div class="container">

<!-- Resumo Financeiro -->
<div class="cards">
    <div class="card">
        <h3>Total Gasto</h3>
        <p id="totalGasto">R$ 0,00</p>
    </div>
    <div class="card">
        <h3>MÃ©dia por Categoria</h3>
        <p id="mediaCategoria">R$ 0,00</p>
    </div>
    <div class="card">
        <h3>PrÃ³ximos Vencimentos</h3>
        <p id="proximosVencimentos">0 parcelas</p>
    </div>
</div>

<!-- FormulÃ¡rio Adicionar Parcela -->
<h2>Adicionar Parcela</h2>
<div class="form-group">
    <label for="cartao">CartÃ£o</label>
    <input type="text" id="cartao" placeholder="Ex: Visa">
</div>
<div class="form-group">
    <label for="categoria">Categoria</label>
    <input type="text" id="categoria" placeholder="Ex: Supermercado">
</div>
<div class="form-group">
    <label for="valor">Valor (R$)</label>
    <input type="number" id="valor" step="0.01" placeholder="Ex: 150.00">
</div>
<div class="form-group">
    <label for="data">Data da Parcela</label>
    <input type="date" id="data">
</div>
<button id="adicionar">Adicionar Parcela</button>

<!-- Filtros -->
<h2>Filtros</h2>
<div class="form-group">
    <label for="filtroMes">Filtrar por MÃªs</label>
    <input type="month" id="filtroMes">
</div>
<div class="form-group">
    <label for="filtroCartao">Filtrar por CartÃ£o</label>
    <input type="text" id="filtroCartao">
</div>
<div class="form-group">
    <label for="filtroCategoria">Filtrar por Categoria</label>
    <input type="text" id="filtroCategoria">
</div>
<button id="aplicarFiltro">Aplicar Filtro</button>

<!-- ExportaÃ§Ãµes -->
<button id="exportCSV">Exportar CSV</button>
<button id="exportPDF">Exportar PDF</button>

<!-- Tabela -->
<h2>HistÃ³rico de Parcelas</h2>
<table>
    <thead>
        <tr>
            <th>CartÃ£o</th>
            <th>Categoria</th>
            <th>Valor</th>
            <th>Data</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="historico">
        <tr><td colspan="5" style="text-align:center;">Nenhuma parcela registrada ainda! ðŸ“‹</td></tr>
    </tbody>
</table>

<!-- GrÃ¡ficos -->
<div class="charts">
    <div class="chart-container">
        <h3>Gastos por Categoria</h3>
        <canvas id="graficoCategoria"></canvas>
    </div>
    <div class="chart-container">
        <h3>Gastos por MÃªs</h3>
        <canvas id="graficoMes"></canvas>
    </div>
</div>

<script>
const cores = ['#e74c3c','#3498db','#2ecc71','#9b59b6','#f1c40f','#e67e22','#1abc9c','#34495e'];
let categoriasCores = {};
let historico = JSON.parse(localStorage.getItem('historico')) || [];

function salvarHistorico() { localStorage.setItem('historico', JSON.stringify(historico)); }

function adicionarParcela(cartao, categoria, valor, data) {
    if(!categoriasCores[categoria]) categoriasCores[categoria] = cores[Object.keys(categoriasCores).length % cores.length];
    const parcela = { cartao, categoria, valor: parseFloat(valor), data, cor: categoriasCores[categoria] };
    historico.push(parcela);
    salvarHistorico();
    renderizarHistorico(historico);
    atualizarGraficos();
    atualizarResumo();
}

function renderizarHistorico(lista) {
    const tbody = document.getElementById('historico');
    tbody.innerHTML = '';
    if(lista.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhuma parcela encontrada! ðŸ“‹</td></tr>'; return; }
    const hoje = new Date();
    lista.forEach(p => {
        const dataParcela = new Date(p.data);
        const diffDias = Math.floor((dataParcela - hoje) / (1000*60*60*24));
        const alerta = diffDias >=0 && diffDias <=7 ? `<span class="alert">Vence em ${diffDias} dias</span>` : '';
        tbody.innerHTML += `
            <tr>
                <td><span class="badge" style="background:${p.cor}">${p.cartao}</span></td>
                <td>${p.categoria}</td>
                <td>R$ ${p.valor.toFixed(2)}</td>
                <td>${p.data}</td>
                <td>${alerta}</td>
            </tr>
        `;
    });
}

function atualizarResumo() {
    // Total Gasto
    const total = historico.reduce((sum, p) => sum + p.valor, 0);
    document.getElementById('totalGasto').innerText = `R$ ${total.toFixed(2)}`;
    // MÃ©dia por Categoria
    const catValores = {};
    historico.forEach(p => { catValores[p.categoria] = (catValores[p.categoria] || []); catValores[p.categoria].push(p.valor); });
    let media = 0;
    const categorias = Object.keys(catValores);
    if(categorias.length > 0) media = categorias.reduce((sum,c) => sum + catValores[c].reduce((a,b)=>a+b,0)/catValores[c].length,0)/categorias.length;
    document.getElementById('mediaCategoria').innerText = `R$ ${media.toFixed(2)}`;
    // PrÃ³ximos Vencimentos
    const hoje = new Date();
    const proximos = historico.filter(p => { const d = new Date(p.data); const diff = Math.floor((d-hoje)/(1000*60*60*24)); return diff>=0 && diff<=7; }).length;
    document.getElementById('proximosVencimentos').innerText = `${proximos} parcelas`;
}

// Filtros
document.getElementById('aplicarFiltro').addEventListener('click', () => {
    const mes = document.getElementById('filtroMes').value;
    const cartao = document.getElementById('filtroCartao').value.toLowerCase();
    const categoria = document.getElementById('filtroCategoria').value.toLowerCase();
    const filtrado = historico.filter(p => {
        let cond = true;
        if(mes) cond = cond && p.data.startsWith(mes);
        if(cartao) cond = cond && p.cartao.toLowerCase().includes(cartao);
        if(categoria) cond = cond && p.categoria.toLowerCase().includes(categoria);
        return cond;
    });
    renderizarHistorico(filtrado);
    atualizarGraficos(filtrado);
});

// Adicionar parcela
document.getElementById('adicionar').addEventListener('click', () => {
    const cartao = document.getElementById('cartao').value;
    const categoria = document.getElementById('categoria').value;
    const valor = document.getElementById('valor').value;
    const data = document.getElementById('data').value;
    if(cartao && categoria && valor && data) {
        adicionarParcela(cartao, categoria, valor, data);
        document.getElementById('cartao').value = '';
        document.getElementById('categoria').value = '';
        document.getElementById('valor').value = '';
        document.getElementById('data').value = '';
    } else { alert('Preencha todos os campos!'); }
});

// Export CSV
document.getElementById('exportCSV').addEventListener('click', () => {
    let csv = "CartÃ£o,Categoria,Valor,Data\n";
    historico.forEach(p => { csv += `"${p.cartao}","${p.categoria}",${p.valor.toFixed(2)},"${p.data}"\n`; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "parcelas.csv";
    link.click();
});

// Export PDF
document.getElementById('exportPDF').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(12);
    doc.text("Dashboard Financeiro - HistÃ³rico de Parcelas", 14, 20);
    let y = 30;
    historico.forEach(p => {
        doc.text(`${p.cartao} | ${p.categoria} | R$ ${p.valor.toFixed(2)} | ${p.data}`, 14, y);
        y += 10;
        if(y>280){ doc.addPage(); y=20; }
    });
    doc.save("parcelas.pdf");
});

// GrÃ¡ficos
let chartCategoria, chartMes;
function atualizarGraficos(lista = historico) {
    // Por Categoria
    const catTotal = {};
    lista.forEach(p => { catTotal[p.categoria] = (catTotal[p.categoria] || 0) + p.valor; });
    const labelsCat = Object.keys(catTotal);
    const dataCat = Object.values(catTotal);
    const colorsCat = labelsCat.map(c => categoriasCores[c]);
    if(chartCategoria) chartCategoria.destroy();
    const ctxCat = document.getElementById('graficoCategoria').getContext('2d');
    chartCategoria = new Chart(ctxCat, { type:'pie', data:{labels:labelsCat,datasets:[{data:dataCat,backgroundColor:colorsCat}]}, options:{responsive:true,plugins:{legend:{position:'bottom'}}}});

    // Por MÃªs
    const mesTotal = {};
    lista.forEach(p => { const mes = p.data.slice(0,7); mesTotal[mes] = (mesTotal[mes]||0)+p.valor; });
    const labelsMes = Object.keys(mesTotal).sort();
    const dataMes = labelsMes.map(m => mesTotal[m]);
    if(chartMes) chartMes.destroy();
    const ctxMes = document.getElementById('graficoMes').getContext('2d');
    chartMes = new Chart(ctxMes, { type:'bar', data:{labels:labelsMes,datasets:[{label:'Gastos (R$)',data:dataMes,backgroundColor:'#3498db'}]}, options:{responsive:true,plugins:{legend:{display:false}}}});
}

// Inicializar
renderizarHistorico(historico);
atualizarGraficos();
atualizarResumo();
</script>
</body>
</html>
